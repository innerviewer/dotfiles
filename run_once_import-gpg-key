#!/usr/bin/env bash
set -euo pipefail

BW_ITEM_ID="a7297cba-6866-41d9-8f7f-b37b00909156"
KEYID="161D8249EA98E2A69F6DFFB154AAF16921261D0F"

echo "ðŸ” Importing GPG key from Bitwarden..."

BW_SESSION=$(bw unlock --raw)

# Ensure Bitwarden CLI is unlocked
if ! bw status | grep -q '"unlocked"'; then
  echo "âŒ Bitwarden is locked. Please run: bw unlock"
  exit 1
fi

# Retrieve the key content (notes field)
GPG_KEY_CONTENT=$(bw get notes "$BW_ITEM_ID")

if [ -z "$GPG_KEY_CONTENT" ]; then
  echo "âŒ Failed to retrieve GPG key from Bitwarden."
  exit 1
fi

# Check if key already exists
if gpg --list-secret-keys "$KEYID" >/dev/null 2>&1; then
  echo "âœ… GPG key for $KEYID already exists. Skipping import."
else
  echo "$GPG_KEY_CONTENT" | gpg --import
  echo "âœ… GPG key imported."
fi

echo -e "trust\n5\ny\nquit" | gpg --command-fd 0 --edit-key "$KEYID" trust
echo "âœ… GPG key trusted (level 5)."

# Configure git signing
git config --global commit.gpgsign true
git config --global tag.gpgSign true

echo "âœ… Git configured for GPG signing."
echo "ðŸŽ‰ All done!"

